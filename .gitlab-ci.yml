default:
  tags:
    - ai-coder-build

stages:
  - test
  - docker

variables:
  GIT_CLEAN_FLAGS: "-ffd"
  GIT_STRATEGY: fetch
  CHECKPOINT_DISABLE: "1"
  PRISMA_HIDE_UPDATE_MESSAGE: "1"
  NO_UPDATE_NOTIFIER: "1"

test:
  stage: test
  image: node:18-bullseye
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH'
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .cache/ci/pnpm-store/
  script:
    - mkdir -p .cache/ci/pnpm-store
    - export PNPM_STORE_DIR="$CI_PROJECT_DIR/.cache/ci/pnpm-store"
    - corepack enable
    - corepack prepare pnpm@9.6.0 --activate
    - pnpm install --frozen-lockfile --store-dir "$PNPM_STORE_DIR"
    - pnpm --filter hookcode-backend test
    - pnpm --filter hookcode-frontend test

docker-build:
  stage: docker
  image: docker:24
  services:
    - name: docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
    BACKEND_IMAGE: hookcode-backend:ci
    FRONTEND_IMAGE: hookcode-frontend:ci
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_TAG'
  script:
    - docker-compose -f docker-compose.yml down --remove-orphans
    - docker-compose -f docker-compose.yml up -d --build
