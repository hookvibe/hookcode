# Compose project name:
# - Keep it stable to avoid creating multiple stacks that bind the same host ports.
# - This is especially important for self-hosted runners that also act as deployment servers.
name: hookcode

services:
  backend:
    build:
      # Build context is the repo root so both `backend/` and `frontend/` workspace packages are available.
      # Change record:
      # - 2026-01-14: Move Compose file under `docker/` and switch context to `..`.
      context: ..
      dockerfile: backend/Dockerfile
      args:
        PRISMA_ENGINES_MIRROR: ${PRISMA_ENGINES_MIRROR}
    env_file:
      # Single Docker deployment env file shared by frontend(build) + backend/worker(runtime).
      - ./.env
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      # Optional host exposure (debugging / local access):
      # - Cloudflare proxy only forwards 80/443, so public access must go through frontend Nginx (`/api/*`).
      # - Default binds to 127.0.0.1 to avoid accidental public exposure and host port conflicts.
      - "${HOOKCODE_BACKEND_BIND:-127.0.0.1}:${HOOKCODE_BACKEND_PORT:-4000}:4000"
    depends_on:
      - db

  worker:
    build:
      context: ..
      dockerfile: backend/Dockerfile
      args:
        PRISMA_ENGINES_MIRROR: ${PRISMA_ENGINES_MIRROR}
    env_file:
      - ./.env
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: ["node", "/repo/backend/dist/worker.js"]
    depends_on:
      - db

  frontend:
    build:
      context: ..
      dockerfile: frontend/Dockerfile
      args:
        # VITE_API_BASE_URL now uses relative path to leverage Nginx reverse proxy
        # This allows API requests to go through the same port (80) as the frontend
        # Solving the Cloudflare port restriction issue (only port 80/443 allowed)
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-/api}
    ports:
      - "${HOOKCODE_FRONTEND_PORT:-5173}:80"
    depends_on:
      - backend

  db:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      # DB_* is used by backend/worker; reuse it for the Postgres container to keep a single env file.
      POSTGRES_DB: ${DB_NAME:-hookcode}
      POSTGRES_USER: ${DB_USER:-hookcode}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-hookcode}
    volumes:
      - db_data:/var/lib/postgresql/data
    ports:
      - "${HOOKCODE_DB_PORT:-5432}:5432"

volumes:
  db_data: {}
