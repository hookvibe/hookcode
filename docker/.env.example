# ==============================================================================
# HookCode Docker Deployment - .env.example
# ==============================================================================
# Notes (do NOT commit real secrets):
# - Copy to `docker/.env` for Docker deployments.
# - This single file is shared by:
#   - Docker Compose variable substitution (ports/images)
#   - Frontend build-time variables (Vite `VITE_*`)
#   - Backend/worker runtime variables
#
# 说明（不要提交真实密钥）：
# - 本文件可复制为 `docker/.env`（用于 Docker 部署）后再修改。
# - 该单文件同时供以下场景使用：
#   - Docker Compose 变量替换（端口/镜像等）
#   - 前端构建期变量（Vite `VITE_*`）
#   - 后端/worker 运行期变量

# ==============================================================================
# Docker Compose - Host Port Mapping
# ==============================================================================

# Frontend public port (maps host -> container:80)
# 前端对外端口（宿主机 -> 容器:80）
HOOKCODE_FRONTEND_PORT=80

# Backend public port (maps host -> container:4000)
# 后端对外端口（宿主机 -> 容器:4000）
# Note: When using Cloudflare proxy, DO NOT rely on this port (only 80/443 are allowed). Use `/api/*` via frontend.
# 注意：使用 Cloudflare 代理时不要依赖该端口（仅允许 80/443），请通过前端 `/api/*` 访问后端。
HOOKCODE_BACKEND_PORT=8000

# Backend bind address for host exposure (default: 127.0.0.1 for safety)
# 后端端口绑定地址（默认 127.0.0.1 更安全）
HOOKCODE_BACKEND_BIND=127.0.0.1

# Postgres public port (maps host -> container:5432)
# 数据库对外端口（宿主机 -> 容器:5432）
HOOKCODE_DB_PORT=5432

# ==============================================================================
# Frontend (Vite build-time)
# ==============================================================================

# Backend API base URL used by the frontend (recommended: `/api` behind Cloudflare)
# 前端请求后端 API 的基地址（Cloudflare 场景推荐使用 `/api`）
VITE_API_BASE_URL=/api

# ==============================================================================
# Build / Tooling
# ==============================================================================

# Prisma engines mirror (optional; useful when prisma binaries CDN is blocked)
# Prisma engine 镜像地址（可选；当 prisma 二进制下载被墙/不稳定时有用）
PRISMA_ENGINES_MIRROR=

# ==============================================================================
# Backend - Server / CORS
# ==============================================================================

# Node environment (development/production/test). In production, set to `production`.
# Node 运行环境（development/production/test）。生产环境建议设为 `production`。
NODE_ENV=production

# Backend HTTP port inside container (must match Dockerfile EXPOSE; default: 4000)
# 后端容器内监听端口（需与 Dockerfile EXPOSE 一致；默认：4000）
PORT=4000

# Backend listen host (Docker/prod recommended: 0.0.0.0)
# 后端监听地址（Docker/生产建议：0.0.0.0）
HOST=0.0.0.0

# Allowed CORS origins (comma-separated; supports `*`)
# 允许的前端 Origin（逗号分隔；支持 `*`）
ALLOWED_ORIGIN=*

# ==============================================================================
# Backend - Database (used by backend + worker)
# ==============================================================================

# Database host (Docker Compose service name: `db`)
# 数据库主机（Docker Compose 服务名：`db`）
DB_HOST=db

# Database port (Postgres default: 5432)
# 数据库端口（Postgres 默认：5432）
DB_PORT=5432

# Database username
# 数据库用户名
DB_USER=hookcode

# Database password
# 数据库密码
DB_PASSWORD=hookcode

# Database name
# 数据库名称
DB_NAME=hookcode

# ==============================================================================
# Backend - Auth (console access + user system)
# ==============================================================================

# Enable auth for console & APIs (when true, frontend must send `Authorization: Bearer <token>`)
# 是否启用控制台/API 鉴权（开启后前端请求需带 `Authorization: Bearer <token>`）
AUTH_ENABLED=true

# Secret for issuing/verifying tokens (MUST be long & stable in production)
# token 签发/校验密钥（生产环境必须设置为长随机串且保持稳定）
AUTH_TOKEN_SECRET=change-me-in-prod

# Token TTL in seconds (default: 604800 = 7 days)
# token 有效期（秒，默认：604800 = 7 天）
AUTH_TOKEN_TTL_SECONDS=604800

# Bootstrap admin user when users table is empty
# 首次启动时在 users 表为空时自动创建管理员账号
AUTH_BOOTSTRAP_ADMIN=true

# Bootstrap admin username (effective when AUTH_BOOTSTRAP_ADMIN=true)
# 初始化管理员用户名（AUTH_BOOTSTRAP_ADMIN=true 时生效）
AUTH_ADMIN_USERNAME=admin

# Bootstrap admin password (MUST set explicitly in production)
# 初始化管理员密码（生产环境必须显式设置）
# Example: use a strong password and keep it secret
# 示例：请使用强密码并妥善保管
AUTH_ADMIN_PASSWORD=admin

# Whether `/api/health` is exempt from auth (default: true)
# 是否放行 `/api/health`（默认：true）
AUTH_EXEMPT_HEALTH=true

# Whether to allow self-service registration (recommended: false in production)
# 是否允许自助注册（生产环境建议：false）
AUTH_REGISTER_ENABLED=false

# Whether registration requires email verification (default: true)
# 注册后是否必须邮箱验证（默认：true）
AUTH_REGISTER_REQUIRE_EMAIL_VERIFY=true

# Email verification token TTL in seconds (default: 86400 = 1 day)
# 邮箱验证链接有效期（秒，默认：86400 = 1 天）
AUTH_EMAIL_VERIFY_TOKEN_TTL_SECONDS=86400

# Console base URL (used to generate email verification links; must be browser-reachable)
# 控制台基地址（用于生成邮箱验证链接；必须能被浏览器访问）
HOOKCODE_CONSOLE_BASE_URL=http://localhost

# Console task URL prefix (used as hint link when a task fails; should end with `/`)
# 控制台任务详情链接前缀（任务失败时作为提示链接；建议以 `/` 结尾）
HOOKCODE_CONSOLE_TASK_URL_PREFIX=http://localhost/#/tasks/

# ==============================================================================
# GitLab / GitHub Integration (optional but recommended)
# ==============================================================================

# GitLab webhook secret (required when GitLab webhooks are enabled)
# GitLab Webhook 密钥（启用 GitLab Webhook 时必填）
GITLAB_WEBHOOK_SECRET=

# GitLab personal access token (required to post comments / fetch diffs)
# GitLab 个人访问令牌（用于发评论/拉 diff 等）
GITLAB_PERSONAL_ACCESS_TOKEN=

# GitHub webhook secret (required when GitHub webhooks are enabled)
# GitHub Webhook 密钥（启用 GitHub Webhook 时必填）
GITHUB_WEBHOOK_SECRET=

# GitHub personal access token (required to post comments / fetch diffs)
# GitHub 个人访问令牌（用于发评论/拉 diff 等）
GITHUB_PERSONAL_ACCESS_TOKEN=

# ==============================================================================
# Task Logs (optional)
# ==============================================================================

# Enable task logs persistence and user access (logs API + SSE live logs)
# 是否启用任务日志写入数据库并对用户可见（logs API + SSE 实时日志）
TASK_LOGS_ENABLED=false

# ==============================================================================
# Admin Tools (optional; extra ports, trusted networks only)
# ==============================================================================

# Enable admin tools (starts extra HTTP ports; use only on trusted networks)
# 是否启用管理员工具（会额外开放端口；仅建议在可信网络/加防火墙场景使用）
ADMIN_TOOLS_ENABLED=false

# Start admin tools inside the backend API process
# 是否在后端 API 进程内启动管理员工具
ADMIN_TOOLS_EMBEDDED=true

# Listen host for admin tools
# 管理员工具监听地址
ADMIN_TOOLS_HOST=127.0.0.1

# Prisma Studio public port (auth-protected proxy)
# Prisma Studio 对外端口（带鉴权代理）
ADMIN_TOOLS_PRISMA_PORT=6555

# Swagger UI public port (auth-protected)
# Swagger UI 对外端口（带鉴权）
ADMIN_TOOLS_SWAGGER_PORT=7555

# Prisma Studio upstream port (loopback only; auto-increments if occupied)
# Prisma Studio 上游端口（仅 loopback；如被占用会自动递增）
ADMIN_TOOLS_PRISMA_UPSTREAM_PORT=5555

# Swagger OpenAPI `servers[0].url` (must be browser-reachable backend API base URL)
# Swagger OpenAPI `servers[0].url`（必须是浏览器可访问的后端 API Base URL）
ADMIN_TOOLS_API_BASE_URL=http://localhost/api

# Cookie Secure flag (HTTPS-only cookies; keep false for plain HTTP)
# Cookie Secure 标记（仅 HTTPS；纯 HTTP 环境保持 false）
ADMIN_TOOLS_COOKIE_SECURE=false

# ==============================================================================
# Email (smtp/console/noop)
# ==============================================================================

# Email provider: `smtp` (real email), `console` (log to stdout), `noop` (discard)
# 邮件发送方式：`smtp`（真实邮件）、`console`（输出到日志）、`noop`（丢弃）
EMAIL_PROVIDER=console

# SMTP host (effective when EMAIL_PROVIDER=smtp)
# SMTP 主机（EMAIL_PROVIDER=smtp 时生效）
SMTP_HOST=smtp.example.com

# SMTP port (commonly 587 or 465)
# SMTP 端口（常见 587 或 465）
SMTP_PORT=587

# Whether to use SMTPS (implicit TLS). For STARTTLS (587) keep false.
# 是否使用 SMTPS（隐式 TLS）。如走 587 STARTTLS 一般保持 false。
SMTP_SECURE=false

# SMTP auth username
# SMTP 用户名
SMTP_USER=replace-with-smtp-username

# SMTP auth password
# SMTP 密码
SMTP_PASS=replace-with-smtp-password

# From address (keep quotes if contains spaces)
# 发件人（如包含空格请保留引号）
SMTP_FROM="HookCode <no-reply@example.com>"

# Reject unauthorized TLS certs (set false only if you fully trust your SMTP and accept the risk)
# 是否拒绝不受信任的 TLS 证书（仅在完全信任 SMTP 且接受风险时才可设为 false）
SMTP_TLS_REJECT_UNAUTHORIZED=true

# ==============================================================================
# Worker / crash recovery
# ==============================================================================

# Inline worker: execute tasks in API process after enqueue (true = no standalone worker required)
# 是否启用内联 Worker：任务入队后由 API 进程直接执行（true = 不需要单独 worker 进程）
INLINE_WORKER_ENABLED=false

# Dedicated worker polling interval in ms (effective for standalone worker)
# 独立 Worker 轮询间隔（毫秒；仅独立 worker 生效）
WORKER_POLL_INTERVAL_MS=2000

# Threshold to consider a task "stuck in processing" (ms)
# 任务在 processing 状态判定为“卡死”的阈值（毫秒）
PROCESSING_STALE_MS=1800000

# API process periodic stale-processing recovery interval (ms; default 60000)
# API 进程定时回收“卡死任务”的间隔（毫秒；默认 60000）
PROCESSING_STALE_RECOVERY_INTERVAL_MS=60000

# Preferred worker mode: hold a PG advisory lock
# 首选 Worker 模式：持有 PG advisory lock
WORKER_PREFERRED=false

# Back off when a preferred worker is detected (pause consuming)
# 侦测到首选 Worker 时是否退让暂停消费
WORKER_BACKOFF_ON_PREFERRED=false
