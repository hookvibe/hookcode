# ==============================================================================
# HookCode Backend - .env.example
# ==============================================================================
# Notes (do NOT commit real secrets):
# - Copy to `backend/.env` for local development or Docker deployments.
# - `.env*` files are gitignored by default (see `.gitignore`).
#
# 说明（不要提交真实密钥）：
# - 本文件可复制为 `backend/.env`（本地开发或 Docker 部署）后再修改。
# - `.env*` 默认在 `.gitignore` 中被忽略。

# ==============================================================================
# Build / Tooling
# ==============================================================================

# Prisma engines mirror (optional; mainly for CI/docker build when binaries.prisma.sh is blocked)
# Prisma engine 镜像地址（可选；主要用于 CI/docker build 网络受限时）
# Example: https://npmmirror.com/mirrors/prisma
# 示例：https://npmmirror.com/mirrors/prisma
PRISMA_ENGINES_MIRROR=

# Node environment (development/production/test). In production, set to `production`.
# Node 运行环境（development/production/test）。生产环境建议设为 `production`。
NODE_ENV=development

# ==============================================================================
# Server / CORS
# ==============================================================================

# Backend HTTP port (default: 4000)
# 后端 HTTP 端口（默认：4000）
PORT=4000

# Backend listen host (local dev recommended: 127.0.0.1; Docker/prod recommended: 0.0.0.0)
# 后端监听地址（本地开发建议：127.0.0.1；Docker/生产建议：0.0.0.0）
HOST=0.0.0.0

# Allowed CORS origins (comma-separated; supports `*`)
# 允许的前端 Origin（逗号分隔；支持 `*`）
ALLOWED_ORIGIN=*

# ==============================================================================
# Auth (console access + user system)
# ==============================================================================

# Enable auth for console & APIs (when true, frontend must send `Authorization: Bearer <token>`)
# 是否启用控制台/API 鉴权（开启后前端请求需带 `Authorization: Bearer <token>`）
AUTH_ENABLED=true

# Secret for issuing/verifying tokens (MUST be long & stable in production)
# token 签发/校验密钥（生产环境必须设置为长随机串且保持稳定）
AUTH_TOKEN_SECRET=change-me-in-prod

# Token TTL in seconds (default: 604800 = 7 days)
# token 有效期（秒，默认：604800 = 7 天）
AUTH_TOKEN_TTL_SECONDS=604800

# Bootstrap admin user when users table is empty (recommended: true for first install, then keep enabled/disabled as needed)
# 首次启动时在 users 表为空时自动创建管理员账号（可按需启用/关闭）
AUTH_BOOTSTRAP_ADMIN=true

# Bootstrap admin username (effective when AUTH_BOOTSTRAP_ADMIN=true)
# 初始化管理员用户名（AUTH_BOOTSTRAP_ADMIN=true 时生效）
AUTH_ADMIN_USERNAME=admin

# Bootstrap admin password (MUST set explicitly in production; dev fallback may use "admin" when NODE_ENV!=production)
# 初始化管理员密码（生产环境必须显式设置；开发环境在 NODE_ENV!=production 时可能回退为 "admin"）
AUTH_ADMIN_PASSWORD=admin

# Whether `/api/health` is exempt from auth (default: true)
# 是否放行 `/api/health`（默认：true）
AUTH_EXEMPT_HEALTH=true

# Whether to allow self-service registration (recommended: false in production)
# 是否允许自助注册（生产环境建议：false）
AUTH_REGISTER_ENABLED=false

# Whether registration requires email verification (default: true)
# 注册后是否必须邮箱验证（默认：true）
AUTH_REGISTER_REQUIRE_EMAIL_VERIFY=true

# Disable account display-name/password editing in the console (optional; default: false)
# 是否禁用控制台中的账号显示名/密码编辑功能（可选；默认：false）
# Notes: this flag is shared with the frontend build (Vite `VITE_*`) and enforced on the backend.
# 说明：该开关会被前端构建读取（Vite `VITE_*`），后端也会强制校验作为安全边界。
VITE_DISABLE_ACCOUNT_EDIT=false

# Email verification token TTL in seconds (default: 86400 = 1 day)
# 邮箱验证链接有效期（秒，默认：86400 = 1 天）
AUTH_EMAIL_VERIFY_TOKEN_TTL_SECONDS=86400

# Console base URL (used to generate email verification links; must be browser-reachable)
# 控制台基地址（用于生成邮箱验证链接；必须能被浏览器访问）
HOOKCODE_CONSOLE_BASE_URL=http://localhost:5173

# Console task URL prefix (used as hint link when a task fails; should end with `/`)
# 控制台任务详情链接前缀（任务失败时作为提示链接；建议以 `/` 结尾）
HOOKCODE_CONSOLE_TASK_URL_PREFIX=http://localhost:5173/#/tasks/

# ==============================================================================
# GitLab reporting & log details (optional)
# ==============================================================================

# Whether to include collapsible execution logs in GitLab comments (default: true)
# 是否在 GitLab 评论中附带可折叠的执行日志（默认：true）
GITLAB_LOG_DETAILS_ENABLED=false

# Whether to expand the collapsible log section by default (default: false)
# 折叠日志是否默认展开（默认：false）
GITLAB_LOG_DETAILS_OPEN=false

# Collapsible log section title (any text)
# 折叠日志的标题（可自定义文本）
GITLAB_LOG_DETAILS_SUMMARY="Show execution details"

# ==============================================================================
# Task logs (console + API)
# ==============================================================================

# Enable persisting task logs to DB (default: true). nykx5svtlgh050cstyht
# 是否启用任务日志写入数据库（默认：true）
TASK_LOGS_DB_ENABLED=true

# Enable exposing task logs to users (logs API + SSE live logs) (default: true). nykx5svtlgh050cstyht
# 是否启用任务日志对用户可见（logs API + SSE 实时日志）（默认：true）
TASK_LOGS_VISIBLE_ENABLED=true

# Track provider output root outside repos to avoid git pollution. docs/en/developer/plans/codexoutputdir20260124/task_plan.md codexoutputdir20260124
# Root directory for provider output artifacts (codex/claude/gemini output files); default: ~/.hookcode/task-outputs
# 模型输出文件根目录（codex/claude/gemini 输出文件）；默认：~/.hookcode/task-outputs
HOOKCODE_TASK_OUTPUT_DIR=

# ==============================================================================
# Git Proxy (for network-restricted environments)
# ==============================================================================

# HTTP/HTTPS proxy for git operations (clone/push/pull/fetch)
# 用于 git 操作（clone/push/pull/fetch）的 HTTP/HTTPS 代理
# Example: http://127.0.0.1:7890
# 示例: http://127.0.0.1:7890
# Note: If your network requires a proxy to access GitHub/GitLab, set this value.
# 说明: 如果你的网络需要代理才能访问 GitHub/GitLab，请设置此值。
GIT_HTTP_PROXY=

# ==============================================================================
# Admin Tools (Prisma Studio / Swagger)
# ==============================================================================

# Enable admin tools (starts extra HTTP ports; use only on trusted networks)
# 是否启用管理员工具（会额外开放端口；仅建议在可信网络/加防火墙场景使用）
ADMIN_TOOLS_ENABLED=false

# Start admin tools inside the backend API process (set false in local dev to avoid restarting tools on backend watch reload)
# 是否在后端 API 进程内启动管理员工具（本地开发建议设为 false，避免后端 watch 重启导致工具反复断开）
ADMIN_TOOLS_EMBEDDED=true

# Listen host for admin tools (local dev recommended: 127.0.0.1; Docker/prod recommended: 0.0.0.0)
# 管理员工具监听地址（本地开发建议：127.0.0.1；Docker/生产建议：0.0.0.0）
ADMIN_TOOLS_HOST=127.0.0.1

# Prisma Studio public port (auth-protected proxy)
# Prisma Studio 对外端口（带鉴权代理）
ADMIN_TOOLS_PRISMA_PORT=6555

# Swagger UI public port (auth-protected)
# Swagger UI 对外端口（带鉴权）
ADMIN_TOOLS_SWAGGER_PORT=7555

# Prisma Studio upstream port (loopback only; auto-increments if occupied)
# Prisma Studio 上游端口（仅 loopback；如被占用会自动递增）
ADMIN_TOOLS_PRISMA_UPSTREAM_PORT=5555

# Swagger OpenAPI `servers[0].url` (must be browser-reachable backend API base URL)
# Swagger OpenAPI `servers[0].url`（必须是浏览器可访问的后端 API Base URL）
ADMIN_TOOLS_API_BASE_URL=http://localhost:4000/api

# Cookie Secure flag (HTTPS-only cookies; keep false for plain HTTP)
# Cookie Secure 标记（仅 HTTPS；纯 HTTP 环境保持 false）
ADMIN_TOOLS_COOKIE_SECURE=false


# ==============================================================================
# Worker / crash recovery
# ==============================================================================

# Inline worker: execute tasks in API process after enqueue (true = no standalone worker required)
# 是否启用内联 Worker：任务入队后由 API 进程直接执行（true = 不需要单独 worker 进程）
INLINE_WORKER_ENABLED=true

# Dedicated worker polling interval in ms (effective for standalone worker)
# 独立 Worker 轮询间隔（毫秒；仅独立 worker 生效）
WORKER_POLL_INTERVAL_MS=2000

# Threshold to consider a task "stuck in processing" (ms)
# 任务在 processing 状态判定为“卡死”的阈值（毫秒）
PROCESSING_STALE_MS=1800000

# API process periodic stale-processing recovery interval (ms; default 60000)
# API 进程定时回收“卡死任务”的间隔（毫秒；默认 60000）
PROCESSING_STALE_RECOVERY_INTERVAL_MS=60000

# Preferred worker mode: hold a PG advisory lock (useful when multiple workers share the same DB)
# 首选 Worker 模式：持有 PG advisory lock（多 worker 共用 DB 时可避免互相抢任务）
WORKER_PREFERRED=false

# Back off when a preferred worker is detected (pause consuming; useful when local dev shares DB with prod)
# 侦测到首选 Worker 时是否退让暂停消费（本地与生产共用 DB 时可用）
WORKER_BACKOFF_ON_PREFERRED=false

# ==============================================================================
# Queue / AI service
# ==============================================================================

# Queue concurrency (max parallel tasks inside a worker process)
# 队列并发数（单个 worker 进程内最大并行任务数）
QUEUE_CONCURRENCY=5

# AI service endpoint (internal service URL)
# AI 服务地址（内部服务 URL）
AI_SERVICE_URL=http://ai-service:8080/analyze

# AI request timeout in ms
# AI 请求超时时间（毫秒）
AI_TIMEOUT_MS=20000

# ==============================================================================
# Database (Postgres / Prisma)
# ==============================================================================

# Database URL (takes precedence over DB_HOST/DB_PORT/DB_USER/DB_PASSWORD/DB_NAME)
# 数据库连接串（优先级高于 DB_HOST/DB_PORT/DB_USER/DB_PASSWORD/DB_NAME）
DATABASE_URL=postgresql://hookcode:hookcode@localhost:5432/hookcode?schema=public

# Test database URL (integration tests only; will wipe data, use a dedicated test DB!)
# 测试数据库连接串（仅集成测试使用；会清空数据，请使用独立测试库！）
DATABASE_URL_TEST=postgresql://hookcode:hookcode@localhost:5432/hookcode_test?schema=public

# DB host (used only when DATABASE_URL is empty)
# DB 主机（仅当 DATABASE_URL 为空时使用）
DB_HOST=localhost

# DB port (used only when DATABASE_URL is empty)
# DB 端口（仅当 DATABASE_URL 为空时使用）
DB_PORT=5432

# DB username (used only when DATABASE_URL is empty)
# DB 用户名（仅当 DATABASE_URL 为空时使用）
DB_USER=replace-with-username

# DB password (used only when DATABASE_URL is empty)
# DB 密码（仅当 DATABASE_URL 为空时使用）
DB_PASSWORD=replace-with-password

# DB name (used only when DATABASE_URL is empty)
# DB 库名（仅当 DATABASE_URL 为空时使用）
DB_NAME=hookcode

# Auto-apply pending SQL migrations on startup (recommended: true)
# 是否在启动时自动执行未执行的数据库迁移（建议：true）
HOOKCODE_DB_AUTO_MIGRATE=true

# Allow potentially destructive migrations (DROP/TRUNCATE/DELETE) (default: false; backup DB before enabling!)
# 是否允许执行可能导致数据丢失的迁移（默认：false；开启前请先备份数据库！）
HOOKCODE_DB_ACCEPT_DATA_LOSS=false

# Override migrations directory (absolute path or relative to project root)
# 自定义 migrations 目录（可填绝对路径或相对项目根目录）
HOOKCODE_MIGRATIONS_DIR=
